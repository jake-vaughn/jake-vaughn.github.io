<!DOCTYPE html><html lang="en" ><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"><meta name="layout-lang" content="en"><meta name="day-prompt" content="d ago"><meta name="hour-prompt" content="hr ago"><meta name="minute-prompt" content="min ago"><meta name="justnow-prompt" content="just now"><meta name="generator" content="Jekyll v4.3.2" /><meta property="og:title" content="Modifying EVM Bytecode Function Selectors" /><meta name="author" content="Jake Vaughn" /><meta property="og:locale" content="en" /><meta name="description" content="Overview: Function selectors are a way of identifying functions in EVM (Ethereum Virtual Machine) smart contracts. These function signatures are hashed using the keccak256 algorithm, and the first 4 bytes of the resulting hash are used as the function selector. This allows for the identification of the function and the parameters it takes, so that the caller can provide the correct information and the correct function can be called by the smart contract." /><meta property="og:description" content="Overview: Function selectors are a way of identifying functions in EVM (Ethereum Virtual Machine) smart contracts. These function signatures are hashed using the keccak256 algorithm, and the first 4 bytes of the resulting hash are used as the function selector. This allows for the identification of the function and the parameters it takes, so that the caller can provide the correct information and the correct function can be called by the smart contract." /><link rel="canonical" href="https://jake-vaughn.com/posts/Modifying_EVM_Bytecode_Function_Selectors/" /><meta property="og:url" content="https://jake-vaughn.com/posts/Modifying_EVM_Bytecode_Function_Selectors/" /><meta property="og:site_name" content="Jake Vaughn" /><meta property="og:type" content="article" /><meta property="article:published_time" content="2022-10-24T08:00:00-05:00" /><meta name="twitter:card" content="summary" /><meta property="twitter:title" content="Modifying EVM Bytecode Function Selectors" /><meta name="twitter:site" content="@NA" /><meta name="twitter:creator" content="@Jake Vaughn" /><meta name="google-site-verification" content="google_meta_tag_verification" /> <script type="application/ld+json"> {"@context":"https://schema.org","@type":"BlogPosting","author":{"@type":"Person","name":"Jake Vaughn"},"dateModified":"2022-12-07T21:52:46-06:00","datePublished":"2022-10-24T08:00:00-05:00","description":"Overview: Function selectors are a way of identifying functions in EVM (Ethereum Virtual Machine) smart contracts. These function signatures are hashed using the keccak256 algorithm, and the first 4 bytes of the resulting hash are used as the function selector. This allows for the identification of the function and the parameters it takes, so that the caller can provide the correct information and the correct function can be called by the smart contract.","headline":"Modifying EVM Bytecode Function Selectors","mainEntityOfPage":{"@type":"WebPage","@id":"https://jake-vaughn.com/posts/Modifying_EVM_Bytecode_Function_Selectors/"},"url":"https://jake-vaughn.com/posts/Modifying_EVM_Bytecode_Function_Selectors/"}</script><title>Modifying EVM Bytecode Function Selectors | Jake Vaughn</title><link rel="apple-touch-icon" sizes="180x180" href="/assets/img/favicons/apple-touch-icon.png"><link rel="icon" type="image/png" sizes="32x32" href="/assets/img/favicons/favicon-32x32.png"><link rel="icon" type="image/png" sizes="16x16" href="/assets/img/favicons/favicon-16x16.png"><link rel="manifest" href="/assets/img/favicons/site.webmanifest"><link rel="shortcut icon" href="/assets/img/favicons/favicon.ico"><meta name="apple-mobile-web-app-title" content="Jake Vaughn"><meta name="application-name" content="Jake Vaughn"><meta name="msapplication-TileColor" content="#da532c"><meta name="msapplication-config" content="/assets/img/favicons/browserconfig.xml"><meta name="theme-color" content="#ffffff"><link rel="preconnect" href="https://fonts.gstatic.com" crossorigin="anonymous"><link rel="dns-prefetch" href="https://fonts.gstatic.com"><link rel="preconnect" href="https://www.google-analytics.com" crossorigin="use-credentials"><link rel="dns-prefetch" href="https://www.google-analytics.com"><link rel="preconnect" href="https://www.googletagmanager.com" crossorigin="anonymous"><link rel="dns-prefetch" href="https://www.googletagmanager.com"><link rel="preconnect" href="https://cdn.jsdelivr.net"><link rel="dns-prefetch" href="https://cdn.jsdelivr.net"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.0.0/dist/css/bootstrap.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5.11.2/css/all.min.css"><link rel="stylesheet" href="/assets/css/style.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/afeld/bootstrap-toc@1.0.1/dist/bootstrap-toc.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/magnific-popup@1.1.0/dist/magnific-popup.min.css"> <script src="https://cdn.jsdelivr.net/npm/jquery@3/dist/jquery.min.js"></script><body data-spy="scroll" data-target="#toc"><div id="sidebar" class="d-flex flex-column align-items-end" lang=""><div class="profile-wrapper text-center"><div id="avatar"> <a href="/" alt="avatar" class="mx-auto"> <img src="/assets/img/profilepic.jpg" alt="avatar" onerror="this.style.display='none'"> </a></div><div class="site-title mt-3"> <a href="/">Jake Vaughn</a></div><div class="site-subtitle font-italic">Welcome to my page!</div></div><ul class="w-100"><li class="nav-item"> <a href="/" class="nav-link"> <i class="fa-fw fas fa-home ml-xl-3 mr-xl-3 unloaded"></i> <span>HOME</span> </a><li class="nav-item"> <a href="/categories/" class="nav-link"> <i class="fa-fw fas fa-stream ml-xl-3 mr-xl-3 unloaded"></i> <span>CATEGORIES</span> </a><li class="nav-item"> <a href="/guides/" class="nav-link"> <i class="fa-fw fas fa-book ml-xl-3 mr-xl-3 unloaded"></i> <span>GUIDES</span> </a><li class="nav-item"> <a href="/projects/" class="nav-link"> <i class="fa-fw fas fa-wave-square ml-xl-3 mr-xl-3 unloaded"></i> <span>PROJECTS</span> </a><li class="nav-item"> <a href="/reflections/" class="nav-link"> <i class="fa-fw fas fa-briefcase ml-xl-3 mr-xl-3 unloaded"></i> <span>REFLECTIONS</span> </a><li class="nav-item"> <a href="/resume/" class="nav-link"> <i class="fa-fw fas fa-file ml-xl-3 mr-xl-3 unloaded"></i> <span>RESUME</span> </a><li class="nav-item"> <a href="/tags/" class="nav-link"> <i class="fa-fw fas fa-tags ml-xl-3 mr-xl-3 unloaded"></i> <span>TAGS</span> </a><li class="nav-item"> <a href="/archives/" class="nav-link"> <i class="fa-fw fas fa-archive ml-xl-3 mr-xl-3 unloaded"></i> <span>ARCHIVES</span> </a><li class="nav-item"> <a href="/about/" class="nav-link"> <i class="fa-fw fas fa-info ml-xl-3 mr-xl-3 unloaded"></i> <span>ABOUT</span> </a></ul><div class="sidebar-bottom mt-auto d-flex flex-wrap justify-content-center"> <a href="https://github.com/jake-vaughn" aria-label="github" class="order-3" target="_blank" rel="noopener"> <i class="fab fa-github-alt"></i> </a> <a href=" javascript:location.href = 'mailto:' + ['jakevon358','gmail.com'].join('@')" aria-label="email" class="order-4" > <i class="fas fa-envelope"></i> </a> <a href="/feed.xml" aria-label="rss" class="order-5" > <i class="fas fa-rss"></i> </a> <a href="https://www.linkedin.com/in/jakevaughn/" aria-label="linkedin" class="order-6" target="_blank" rel="noopener"> <i class="fab fa-linkedin"></i> </a> <span class="icon-border order-2"></span> <span id="mode-toggle-wrapper" class="order-1"> <i class="mode-toggle fas fa-adjust"></i> <script type="text/javascript"> class ModeToggle { static get MODE_KEY() { return "mode"; } static get DARK_MODE() { return "dark"; } static get LIGHT_MODE() { return "light"; } constructor() { if (this.hasMode) { if (this.isDarkMode) { if (!this.isSysDarkPrefer) { this.setDark(); } } else { if (this.isSysDarkPrefer) { this.setLight(); } } } var self = this; /* always follow the system prefers */ this.sysDarkPrefers.addListener(function() { if (self.hasMode) { if (self.isDarkMode) { if (!self.isSysDarkPrefer) { self.setDark(); } } else { if (self.isSysDarkPrefer) { self.setLight(); } } self.clearMode(); } self.updateMermaid(); }); } /* constructor() */ setDark() { $('html').attr(ModeToggle.MODE_KEY, ModeToggle.DARK_MODE); sessionStorage.setItem(ModeToggle.MODE_KEY, ModeToggle.DARK_MODE); } setLight() { $('html').attr(ModeToggle.MODE_KEY, ModeToggle.LIGHT_MODE); sessionStorage.setItem(ModeToggle.MODE_KEY, ModeToggle.LIGHT_MODE); } clearMode() { $('html').removeAttr(ModeToggle.MODE_KEY); sessionStorage.removeItem(ModeToggle.MODE_KEY); } get sysDarkPrefers() { return window.matchMedia("(prefers-color-scheme: dark)"); } get isSysDarkPrefer() { return this.sysDarkPrefers.matches; } get isDarkMode() { return this.mode == ModeToggle.DARK_MODE; } get isLightMode() { return this.mode == ModeToggle.LIGHT_MODE; } get hasMode() { return this.mode != null; } get mode() { return sessionStorage.getItem(ModeToggle.MODE_KEY); } /* get the current mode on screen */ get modeStatus() { if (this.isDarkMode || (!this.hasMode && this.isSysDarkPrefer) ) { return ModeToggle.DARK_MODE; } else { return ModeToggle.LIGHT_MODE; } } updateMermaid() { if (typeof mermaid !== "undefined") { let expectedTheme = (this.modeStatus === ModeToggle.DARK_MODE? "dark" : "default"); let config = { theme: expectedTheme }; /* re-render the SVG › <https://github.com/mermaid-js/mermaid/issues/311#issuecomment-332557344> */ $(".mermaid").each(function() { let svgCode = $(this).prev().children().html(); $(this).removeAttr("data-processed"); $(this).html(svgCode); }); mermaid.initialize(config); mermaid.init(undefined, ".mermaid"); } } flipMode() { if (this.hasMode) { if (this.isSysDarkPrefer) { if (this.isLightMode) { this.clearMode(); } else { this.setLight(); } } else { if (this.isDarkMode) { this.clearMode(); } else { this.setDark(); } } } else { if (this.isSysDarkPrefer) { this.setLight(); } else { this.setDark(); } } this.updateMermaid(); } /* flipMode() */ } /* ModeToggle */ let toggle = new ModeToggle(); $(".mode-toggle").click(function() { toggle.flipMode(); }); </script> </span></div></div><div id="topbar-wrapper" class="row justify-content-center topbar-down"><div id="topbar" class="col-11 d-flex h-100 align-items-center justify-content-between"> <span id="breadcrumb"> <span> <a href="/"> Home </a> </span> <span>Modifying EVM Bytecode Function Selectors</span> </span> <i id="sidebar-trigger" class="fas fa-bars fa-fw"></i><div id="topbar-title"> Post</div><i id="search-trigger" class="fas fa-search fa-fw"></i> <span id="search-wrapper" class="align-items-center"> <i class="fas fa-search fa-fw"></i> <input class="form-control" id="search-input" type="search" aria-label="search" autocomplete="off" placeholder="Search..."> <i class="fa fa-times-circle fa-fw" id="search-cleaner"></i> </span> <span id="search-cancel" >Cancel</span></div></div><div id="main-wrapper"><div id="main"><div class="row"><div id="post-wrapper" class="col-12 col-lg-11 col-xl-8"><div class="post pl-1 pr-1 pl-sm-2 pr-sm-2 pl-md-4 pr-md-4"><h1 data-toc-skip>Modifying EVM Bytecode Function Selectors</h1><div class="post-meta text-muted d-flex flex-column"><div> <span class="semi-bold"> Jake Vaughn </span> on <span class="timeago " data-toggle="tooltip" data-placement="bottom" title="Mon, Oct 24, 2022, 8:00 AM -0500" >Oct 24, 2022<i class="unloaded">2022-10-24T08:00:00-05:00</i> </span></div><div> <span> Updated <span class="timeago lastmod" data-toggle="tooltip" data-placement="bottom" title="Wed, Dec 7, 2022, 9:52 PM -0600" >Dec 7, 2022<i class="unloaded">2022-12-07T21:52:46-06:00</i> </span> </span> <span class="readtime" data-toggle="tooltip" data-placement="bottom" title="1807 words">10 min read</span></div></div><div class="post-content"><h2 id="overview">Overview:</h2><p>Function selectors are a way of identifying functions in EVM (Ethereum Virtual Machine) smart contracts. These function signatures are hashed using the keccak256 algorithm, and the first 4 bytes of the resulting hash are used as the function selector. This allows for the identification of the function and the parameters it takes, so that the caller can provide the correct information and the correct function can be called by the smart contract.</p><p>In this post I will go over how it is posible to change the function selectors of smart-contracts after they have been compiled to bytecode. I will also go over some of the reasons someone might want to do this, or how it could potentially be used in real situations.</p><h2 id="what-is-a-function-selector">What is a Function Selector</h2><p>Function selectors are the first four bytes of the Keccak-256 (SHA-3) hash of a function’s signature. A function signature is made up of the function’s name and the types of its arguments. In Ethereum, the Keccak-256 hash of a function signature is used to identify which function is being called when a contract receives a message. This allows multiple functions with the same name but different argument types to exist within a contract and be distinguished from one another.</p><p>For example, the function signature <code class="language-plaintext highlighter-rouge">transfer(address sender, uint256 amount)</code> would be hashed with Keccak-256 to produce a function selector of <code class="language-plaintext highlighter-rouge">0xa9059cbb</code>. Similarly, the function signature <code class="language-plaintext highlighter-rouge">withdraw(uint256 wad)</code> would be hashed to produce a function selector of <code class="language-plaintext highlighter-rouge">0x2e1a7d4d</code>.</p><p>Function selectors are important because they allow the caller of a contract to specify the exact function they want to call, along with the necessary arguments. This ensures that the correct function is called and that the contract has the necessary information to execute it.</p><p>You can find more information and examples of function selectors on the Solidity By Example website, which has a section dedicated to this topic: <a href="https://solidity-by-example.org/function-selector/">Here</a>.</p><h2 id="my-usecase">My Usecase</h2><p>I recently learned that it’s possible to modify function selectors in order to make it difficult to detect the use of unknown smart contracts. This can be useful for mitigating the risk of using unknown code, but it’s important to note that this approach is not practical or safe as it relies on flying blind without access to the source code. However, for those who are interested in learning more about this technique and my personal use case, here’s how it works:</p><p>First, it’s important to understand that all bytecode is available on the blockchain network. This means that it’s possible to use already deployed smart contract bytecode for your own purposes, although this comes with its own set of risks. In order to make it less obvious that you’re using unknown code, you can create another smart contract that calls your first contract, changing the function hashes used. This makes it difficult to detect with tools like etherscan.</p><p>However, there’s a catch: smart contract addresses are not the same as normal user signing addresses, so any functions that use require <code class="language-plaintext highlighter-rouge">_param1 == addr(_param1)</code> will revert instantly. This means that you need to find a different way to modify the function selectors.</p><p>One approach is to use the fact that hashed functions don’t care about their original names or parameters. Because hashes are a one-way operation, you can change them to anything you want and call them with the new function hash. This will work for some hex codes but not others, and the reason for this is that the compiler does a small optimization for function calls. By using a decompiler like <a href="https://ethervm.io/decompile">ethervm.io</a>, you can see that for most smart contracts the compiler finds the function hash that is numerically between the others and uses it to search for the matching function selector above and below it. This cuts the search time roughly in half.</p><p>Once you understand this, you can change your function hashes, deploy your smart contracts, and hopefully be undetected. However, it’s important to keep in mind that this approach is not practical or safe, and is only recommended as a learning experience. As you gain more knowledge and experience in smart contract design and efficiency, you can move on to creating your own robust smart contracts.</p><h2 id="identifying-function-selectors">Identifying Function Selectors</h2><p>First, you will need the bytecode of your target contract that was used in the smart contract creation. There are two types of bytecode, usually named “bytecode” and “deployed bytecode.” If you are not familiar with the difference between the two, you can read about it in this Medium post: <a href="https://medium.com/coinmonks/the-difference-between-bytecode-and-deployed-bytecode-64594db723df">The difference between bytecode and deployed bytecode</a>.</p><p>To obtain the function hashes, you can use a tool like <a href="https://ethervm.io/decompile">ethervm.io</a>. For this example, we will be using a unknown <a href="https://etherscan.io/address/0xa57bd00134b2850b2a1c55860c9e9ea100fdd6cf#code">MEV Bot smart contract</a> on the Ethereum network. Take the deployed bytecode from etherscan and paste it into the text box at the bottom of ethervm.io. Alternatively, you can use the contract address and hit “decompile.” This will give you a decompiled version of the contract, which you can view <a href="https://ethervm.io/decompile/0xa57Bd00134B2850B2a1c55860c9e9ea100fDd6CF">here</a>.</p><p>Once you have the decompiled contract, you can identify the functions in the hex-compiled smart contract code, also known as the bytecode. In this example, we will change the <code class="language-plaintext highlighter-rouge">0x1cff79cd execute(address,bytes)</code>, <code class="language-plaintext highlighter-rouge">0x78e111f6 Unknown</code>, and <code class="language-plaintext highlighter-rouge">0x9c52a7f1 deny(address)</code> functions.</p><blockquote><p>Note: Using the ethervm.io decompiler requires “deployed bytecode” as input but for the rest of this post we will be working with “bytecode”.</p></blockquote><p><img data-proofer-ignore data-src="/images/modifyingBytecode/mevbotPublicMethods.png" alt="MEV Bot functions snippit" /></p><blockquote><p>Note: “Bytecode” can be found in the Input Data field of the transaction that created the smart contract. For example the MEV bot’s creation transaction <a href="https://etherscan.io/tx/0x0d8fc644c8178a352cd39aed1c3ae58434e422390c96f182b3fd68c53ec070e2">Here</a></p></blockquote><p><strong>Full Bytecode</strong></p><div lang="plaintext" class="language-plaintext highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre>0x608060405234801561001057600080fd5b50604051602080610d628339810180604052602081101561003057600080fd5b5051336000908152602081905260409020600190556100578164010000000061005e810204565b5050610114565b3360009081526020819052604081205460011461007a57600080fd5b600160a060020a03821615156100f157604080517f08c379a000000000000000000000000000000000000000000000000000000000815260206004820152601f60248201527f64732d70726f78792d63616368652d616464726573732d726571756972656400604482015290519081900360640190fd5b5060018054600160a060020a038316600160a060020a0319909116178155919050565b610c3f806101236000396000f3fe6080604052600436106100a3576000357c01000000000000000000000000000000000000000000000000000000009004806378e111f61161007657806378e111f6146102ec578063948f5076146104175780639c52a7f11461045e578063a90e873114610491578063bf353dbb146105be576100a3565b80631cff79cd146100a55780631f6a1eb91461015b57806360c7d2951461028857806365fae35e146102b9575b005b6100a3600480360360408110156100bb57600080fd5b600160a060020a0382351691908101906040810160208201356401000000008111156100e657600080fd5b8201836020820111156100f857600080fd5b8035906020019184600183028401116401000000008311171561011a57600080fd5b91908080601f016020809104026020016040519081016040528093929190818152602001838380828437600092019190915250929550610603945050505050565b6100a36004803603604081101561017157600080fd5b81019060208101813564010000000081111561018c57600080fd5b82018360208201111561019e57600080fd5b803590602001918460018302840111640100000000831117156101c057600080fd5b91908080601f016020809104026020016040519081016040528093929190818152602001838380828437600092019190915250929594936020810193503591505064010000000081111561021357600080fd5b82018360208201111561022557600080fd5b8035906020019184600183028401116401000000008311171561024757600080fd5b91908080601f016020809104026020016040519081016040528093929190818152602001838380828437600092019190915250929550610645945050505050565b34801561029457600080fd5b5061029d610847565b60408051600160a060020a039092168252519081900360200190f35b3480156102c557600080fd5b506100a3600480360360208110156102dc57600080fd5b5035600160a060020a0316610856565b6103a26004803603604081101561030257600080fd5b600160a060020a03823516919081019060408101602082013564010000000081111561032d57600080fd5b82018360208201111561033f57600080fd5b8035906020019184600183028401116401000000008311171561036157600080fd5b91908080601f01602080910402602001604051908101604052809392919081815260200183838082843760009201919091525092955061088f945050505050565b6040805160208082528351818301528351919283929083019185019080838360005b838110156103dc5781810151838201526020016103c4565b50505050905090810190601f1680156104095780820380516001836020036101000a031916815260200191505b509250505060405180910390f35b34801561042357600080fd5b5061044a6004803603602081101561043a57600080fd5b5035600160a060020a03166108fa565b604080519115158252519081900360200190f35b34801561046a57600080fd5b506100a36004803603602081101561048157600080fd5b5035600160a060020a03166109bd565b6103a2600480360360408110156104a757600080fd5b8101906020810181356401000000008111156104c257600080fd5b8201836020820111156104d457600080fd5b803590602001918460018302840111640100000000831117156104f657600080fd5b91908080601f016020809104026020016040519081016040528093929190818152602001838380828437600092019190915250929594936020810193503591505064010000000081111561054957600080fd5b82018360208201111561055b57600080fd5b8035906020019184600183028401116401000000008311171561057d57600080fd5b91908080601f0160208091040260200160405190810160405280939291908181526020018383808284376000920191909152509295506109f3945050505050565b3480156105ca57600080fd5b506105f1600480360360208110156105e157600080fd5b5035600160a060020a0316610c01565b60408051918252519081900360200190f35b3360009081526020819052604090205460011461061f57600080fd5b600080825160208401855af480156001811461063a5761063f565b600080fd5b50505050565b6001546040517f8bf4515c000000000000000000000000000000000000000000000000000000008152602060048201818152855160248401528551600094600160a060020a031693638bf4515c938893928392604401918501908083838b5b838110156106bc5781810151838201526020016106a4565b50505050905090810190601f1680156106e95780820380516001836020036101000a031916815260200191505b509250505060206040518083038186803b15801561070657600080fd5b505afa15801561071a573d6000803e3d6000fd5b505050506040513d602081101561073057600080fd5b50519050600160a060020a0381161515610838576001546040517f7ed0c3b2000000000000000000000000000000000000000000000000000000008152602060048201818152865160248401528651600160a060020a0390941693637ed0c3b293889383926044909201919085019080838360005b838110156107bd5781810151838201526020016107a5565b50505050905090810190601f1680156107ea5780820380516001836020036101000a031916815260200191505b5092505050602060405180830381600087803b15801561080957600080fd5b505af115801561081d573d6000803e3d6000fd5b505050506040513d602081101561083357600080fd5b505190505b6108428183610603565b505050565b600154600160a060020a031681565b3360009081526020819052604090205460011461087257600080fd5b600160a060020a0316600090815260208190526040902060019055565b336000908152602081905260409020546060906001146108ae57600080fd5b600080835160208501865af43d6040519250601f19601f6020830101168301604052808352806000602085013e8115600181146108ea576108f1565b8160208501fd5b50505092915050565b3360009081526020819052604081205460011461091657600080fd5b600160a060020a038216151561098d57604080517f08c379a000000000000000000000000000000000000000000000000000000000815260206004820152601f60248201527f64732d70726f78792d63616368652d616464726573732d726571756972656400604482015290519081900360640190fd5b5060018054600160a060020a03831673ffffffffffffffffffffffffffffffffffffffff19909116178155919050565b336000908152602081905260409020546001146109d957600080fd5b600160a060020a0316600090815260208190526040812055565b6001546040517f8bf4515c000000000000000000000000000000000000000000000000000000008152602060048201818152855160248401528551606094600094600160a060020a0390911693638bf4515c93899390928392604490910191908501908083838b5b83811015610a73578181015183820152602001610a5b565b50505050905090810190601f168015610aa05780820380516001836020036101000a031916815260200191505b509250505060206040518083038186803b158015610abd57600080fd5b505afa158015610ad1573d6000803e3d6000fd5b505050506040513d6020811015610ae757600080fd5b50519050600160a060020a0381161515610bef576001546040517f7ed0c3b2000000000000000000000000000000000000000000000000000000008152602060048201818152875160248401528751600160a060020a0390941693637ed0c3b293899383926044909201919085019080838360005b83811015610b74578181015183820152602001610b5c565b50505050905090810190601f168015610ba15780820380516001836020036101000a031916815260200191505b5092505050602060405180830381600087803b158015610bc057600080fd5b505af1158015610bd4573d6000803e3d6000fd5b505050506040513d6020811015610bea57600080fd5b505190505b610bf9818461088f565b949350505050565b6000602081905290815260409020548156fea165627a7a72305820d2cb37091b9fea78618babf87ea1e2213f2acdaa5676752f200e6d4bdd52ab080029000000000000000000000000f3c9d00c06e6ceef470510ed599bd30569a2ddc6
</pre></table></code></div></div><p><strong>Shortened Bytecode With Functions Highlighted</strong> 0x608060405234801561001057600080fd5b50604051602080610d628339810180604052602081101561003057600080fd5b5051336000908152602081905260409020600190556100578164010000000061005e810204565b5050610114565b3360009081526020819052604081205460011461007a57600080fd5b600160a060020a03821615156100f157604080517f08c379a000000000000000000000000000000000000000000000000000000000815260206004820152601f60248201527f64732d70726f78792d63616368652d616464726573732d726571756972656400604482015290519081900360640190fd5b5060018054600160a060020a038316600160a060020a0319909116178155919050565b610c3f806101236000396000f3fe6080604052600436106100a3576000357c010000000000000000000000000000000000000000000000000000000090048063<code class="language-plaintext highlighter-rouge">78e111f6</code>11610076578063<code class="language-plaintext highlighter-rouge">78e111f6</code>146102ec578063948f507614610417578063<code class="language-plaintext highlighter-rouge">9c52a7f1</code>1461045e578063a90e873114610491578063bf353dbb146105be576100a3565b8063<code class="language-plaintext highlighter-rouge">1cff79cd</code>146100a55780631f6a1eb91461015b57806360c7d2951461028857806365fae35e146102b9575b005b6100a3600480360360408110156100bb57600080fd5b600160a060020a0382351691908101906040810160208201356401000000008111156100e657600080fd5b8201836020820111156100f857600080fd5b8035906020019184600183028401116401000000008311171561011a57600080fd5b919080806…</p><blockquote><p>Note: 78e111f6 gets used twice in the bytecode we will change both.</p></blockquote><h2 id="changing-function-selectors">Changing Function Selectors</h2><p>We can change the 4-byte function selectors in our bytecode to any desired value, with one notable exception. Depending on how the bytecode is compiled, the compiler may optimize it in order to improve the speed at which functions are called. If the bytecode you are modifying has a small number of functions, you may be able to ignore this optimization. However, this is often not the case.</p><p>For example, the <a href="https://ethervm.io/decompile/0xC02aaA39b223FE8D0A0e5C4F27eAD9083C756Cc2">Weth9</a> contract uses a <code class="language-plaintext highlighter-rouge">if (var0 == "function selector"</code> operation to find the correct function selector, while our <a href="https://ethervm.io/decompile/0xa57Bd00134B2850B2a1c55860c9e9ea100fDd6CF">example Mev Bot</a> contract uses an <code class="language-plaintext highlighter-rouge">if (0x78e111f6 &gt; var0)</code> statement first then a <code class="language-plaintext highlighter-rouge">if (var0 == "function selector"</code> to find the function selector. This is because the Mev Bot contract was optimized to use less gas when looking up functions.</p><p>Because of this optimization, we must take it into account when modifying our bytecode.</p><blockquote><p>Note: Complicated and heavily optimized contracts may have nested if statements adding to complexity.</p></blockquote><p>In our example, we need to pick a new function that is either smaller or larger than the numerical midpoint function, depending on whether the original function was smaller or larger than the midpoint function. For instance, if the midpoint function is <code class="language-plaintext highlighter-rouge">0x78e111f6</code> and we want to replace <code class="language-plaintext highlighter-rouge">0x1cff79cd</code>, we need to choose a hex number that is smaller than <code class="language-plaintext highlighter-rouge">0x78e111f6</code>. If we want to replace <code class="language-plaintext highlighter-rouge">0x9c52a7f1</code>, we need to choose a hex number that is larger than <code class="language-plaintext highlighter-rouge">0x78e111f6</code>. However, we can also change the midpoint function itself. Keep in mind, though, that because the bytecode has already been compiled, changing the midpoint function will not change the order of the functions or which functions are greater than or less than the midpoint function. For example, if we change the midpoint function to the largest possible hex number <code class="language-plaintext highlighter-rouge">0xffffffff</code>, we can choose any new hash function for <code class="language-plaintext highlighter-rouge">0x1cff79cd</code>, but we won’t be able to use any hex number for <code class="language-plaintext highlighter-rouge">0x9c52a7f1</code>, because there is no function that is greater than <code class="language-plaintext highlighter-rouge">0xffffffff</code>. Similarly, if we set the midpoint function to <code class="language-plaintext highlighter-rouge">0x00000000</code>, only functions that were originally bigger than the original midpoint would be changeable. It’s also worth noting that changing two or more hashes to the same hash can create unique scenarios that may not be desirable.</p><p>Now that we have changed one or all of the function hashes in our smart contract, we can deploy it using a tool that allows us to send a transaction with the data field. Some popular options include <a href="https://docs.ethers.io/v5/">ethersJS</a> with <a href="https://hardhat.org/">hardhat</a> or <a href="https://lovethewired.github.io/abi-playground">0xPhaze’s ABI Playground</a>. Once the transaction is mined, you can use your contract with the updated function hashes.</p><p>You can call the functions in your contract by creating your own transaction data, or by using a devloper-friendly tool such as hardhat. Keep in mind that the functions will still perform the same tasks as before, but will now have different function selectors.</p><p>Overall, changing the function hashes in a smart contract allows you to deploy an updated version of the contract, while still retaining its original functionality.</p><h2 id="real-world-implications">Real-World Implications</h2><p>The main reason for changing a function selector in bytecode which I detailed in the <a href="#my-usecase">My Usecase</a> section is to obfuscate the functions and their purposes. This can help prevent others from easily identifying and interacting with your contract, and make it harder for them to attack it. For example, there are databases like the <a href="https://www.4byte.directory/">4byte database</a> that contain hashes of well-known functions from verified code and GitHub projects, which makes it easier for people to see what functions a contract uses and interact with them without having the source code. By changing the function selectors, you can make it more difficult for others to detect and access your contract while still using the same bytecode.</p><blockquote><p>Note: An easier way to change function selectors if you have the source code is to change the function names before compilation.</p></blockquote><p>One potential consequence of this knowledge is the potential for malicious use. Because we can change the function hash to any value we want, it is possible to change it to a common function found in databases. This could be a problem if you trust a contract solely based on the function name appearing in a service like Etherscan, MetaMask, or any other wallet provider. Etherscan will only look at the function hash in the transaction data field and assign the function name without verifying the contract. Additionally, this vulnerability can be exploited by creating a function with the same name and parameters in the contract’s source code. Anyone aware of this possibility should be able to avoid falling victim to this trick, but it is important to keep this potential vulnerability in mind for those who use and trust these tools.</p><h2 id="conclusion">Conclusion</h2><p>I hope you enjoyed this novel approach to modifying post-compiled EVM bytecode function selectors. I couldn’t find any other information on this topic online, so I decided to share what I’ve learned. If anyone else has discovered this, or if you have any questions or feedback, feel free to reach out to me. Thanks for reading!</p><blockquote><p>P.S. I recommend giving this a try out yourself with tools such as <a href="https://docs.ethers.io/v5/">ethersJS</a> with <a href="https://hardhat.org/">hardhat</a> or <a href="https://lovethewired.github.io/abi-playground">0xPhaze’s ABI Playground</a> and see what you can do.</p></blockquote></div><div class="post-tail-wrapper text-muted"><div class="post-meta mb-3"> <i class="far fa-folder-open fa-fw mr-1"></i> <a href='/categories/guides/'>Guides</a></div><div class="post-tags"> <i class="fa fa-tags fa-fw mr-1"></i> <a href="/tags/evm/" class="post-tag no-text-decoration" >evm</a> <a href="/tags/bytecode/" class="post-tag no-text-decoration" >bytecode</a> <a href="/tags/function-signatures/" class="post-tag no-text-decoration" >function signatures</a> <a href="/tags/hashing/" class="post-tag no-text-decoration" >hashing</a> <a href="/tags/guide/" class="post-tag no-text-decoration" >guide</a> <a href="/tags/function-selectors/" class="post-tag no-text-decoration" >function selectors</a></div><div class="post-tail-bottom d-flex justify-content-between align-items-center mt-3 pt-5 pb-2"><div class="license-wrapper"> This post is licensed under <a href="https://creativecommons.org/licenses/by/4.0/"> CC BY 4.0 </a> by the author.</div><div class="share-wrapper"> <span class="share-label text-muted mr-1">Share</span> <span class="share-icons"> <a href="https://twitter.com/intent/tweet?text=Modifying EVM Bytecode Function Selectors - Jake Vaughn&url=https://jake-vaughn.com/posts/Modifying_EVM_Bytecode_Function_Selectors/" data-toggle="tooltip" data-placement="top" title="Twitter" target="_blank" rel="noopener" aria-label="Twitter"> <i class="fa-fw fab fa-twitter"></i> </a> <a href="https://www.facebook.com/sharer/sharer.php?title=Modifying EVM Bytecode Function Selectors - Jake Vaughn&u=https://jake-vaughn.com/posts/Modifying_EVM_Bytecode_Function_Selectors/" data-toggle="tooltip" data-placement="top" title="Facebook" target="_blank" rel="noopener" aria-label="Facebook"> <i class="fa-fw fab fa-facebook-square"></i> </a> <a href="https://telegram.me/share?text=Modifying EVM Bytecode Function Selectors - Jake Vaughn&url=https://jake-vaughn.com/posts/Modifying_EVM_Bytecode_Function_Selectors/" data-toggle="tooltip" data-placement="top" title="Telegram" target="_blank" rel="noopener" aria-label="Telegram"> <i class="fa-fw fab fa-telegram"></i> </a> <i class="fa-fw fas fa-link small" onclick="copyLink('', 'Link copied successfully!')" data-toggle="tooltip" data-placement="top" title="Copy link"> </i> </span></div></div></div></div></div><div id="panel-wrapper" class="col-xl-3 pl-2 text-muted topbar-down"><div class="access"><div id="access-lastmod" class="post"> <span>Recent Update</span><ul class="post-content pl-0 pb-1 ml-1 mt-2"><li><a href="/posts/2023_Moonbeam_Node_Server_Setup_Guide/">2023 Moonbeam Node Server Setup Guide</a><li><a href="/posts/CprE308_Shell/">CprE 308 Shell Design</a><li><a href="/posts/Modifying_EVM_Bytecode_Function_Selectors/">Modifying EVM Bytecode Function Selectors</a><li><a href="/posts/Polkadot_Network_Visualization/">Polkadot Network Visualization</a><li><a href="/posts/Cumulative_Reflection/">Cumulative Reflection</a></ul></div><div id="access-tags"> <span>Trending Tags</span><div class="d-flex flex-wrap mt-3 mb-1 mr-3"> <a class="post-tag" href="/tags/portfolio/">portfolio</a> <a class="post-tag" href="/tags/isu/">ISU</a> <a class="post-tag" href="/tags/project/">project</a> <a class="post-tag" href="/tags/guide/">guide</a> <a class="post-tag" href="/tags/bytecode/">bytecode</a> <a class="post-tag" href="/tags/moonbeam/">moonbeam</a> <a class="post-tag" href="/tags/node/">node</a> <a class="post-tag" href="/tags/para-chain/">para-chain</a> <a class="post-tag" href="/tags/reflection/">reflection</a> <a class="post-tag" href="/tags/server/">server</a></div></div></div><script src="https://cdn.jsdelivr.net/gh/afeld/bootstrap-toc@1.0.1/dist/bootstrap-toc.min.js"></script><div id="toc-wrapper" class="pl-0 pr-4 mb-5"> <span class="pl-3 pt-2 mb-2">Contents</span><nav id="toc" data-toggle="toc"></nav></div></div></div><div class="row"><div class="col-12 col-lg-11 col-xl-8"><div id="post-extend-wrapper" class="pl-1 pr-1 pl-sm-2 pr-sm-2 pl-md-4 pr-md-4"><div id="related-posts" class="mt-5 mb-2 mb-sm-4"><h3 class="pt-2 mt-1 mb-4 ml-1" data-toc-skip>Further Reading</h3><div class="card-deck mb-4"><div class="card"> <a href="/posts/ZkSync_Bytecode_From_Contract_Creation_Transaction/"><div class="card-body"> <span class="timeago small" >Nov 30, 2022<i class="unloaded">2022-11-30T08:00:00-06:00</i> </span><h3 class="pt-0 mt-1 mb-3" data-toc-skip>ZkSync Bytecode From Contract Creation Transaction</h3><div class="text-muted small"><p> Overview: This will be a short post on how to obtain a ZkSync 2.0 smart contract’s bytecode from the contract creation transaction. This post will also detail some of the differences between deploy...</p></div></div></a></div><div class="card"> <a href="/posts/2022_Moonbeam_Node_Setup_Guide/"><div class="card-body"> <span class="timeago small" >Nov 8, 2022<i class="unloaded">2022-11-08T08:00:00-06:00</i> </span><h3 class="pt-0 mt-1 mb-3" data-toc-skip>2022 Moonbeam Node Setup Guide</h3><div class="text-muted small"><p> Overview: This is a guide on how to quickly setup and sync a Moonbeam node on a hosted server. Running a node on a Moonbeam-based network allows you to connect to the network, sync with a bootnode,...</p></div></div></a></div><div class="card"> <a href="/posts/2023_Moonbeam_Node_Server_Setup_Guide/"><div class="card-body"> <span class="timeago small" >Mar 29<i class="unloaded">2023-03-29T08:00:00-05:00</i> </span><h3 class="pt-0 mt-1 mb-3" data-toc-skip>2023 Moonbeam Node Server Setup Guide</h3><div class="text-muted small"><p> Overview: Creating a Hetzner Server Downloading Snapshot (optional) Moonbeam Relay Chain Backup Moonbeam Parachain RocksDB Backup Service and Binary Setup Configur...</p></div></div></a></div></div></div><div class="post-navigation d-flex justify-content-between"> <a href="/posts/Polkadot_Network_Visualization/" class="btn btn-outline-primary" prompt="Older"><p>Polkadot Network Visualization</p></a> <a href="/posts/2022_Moonbeam_Node_Setup_Guide/" class="btn btn-outline-primary" prompt="Newer"><p>2022 Moonbeam Node Setup Guide</p></a></div></div></div></div><footer class="d-flex w-100 justify-content-center"><div class="d-flex justify-content-between align-items-center"><div class="footer-left"><p class="mb-0"> © 2023 <a href="https://twitter.com/">Jake Vaughn</a>. <span data-toggle="tooltip" data-placement="top" title="Except where otherwise noted, the blog posts on this site are licensed under the Creative Commons Attribution 4.0 International (CC BY 4.0) License by the author.">Some rights reserved.</span></p></div><div class="footer-right"><p class="mb-0"> Powered by <a href="https://jekyllrb.com" target="_blank" rel="noopener">Jekyll</a> with <a href="https://github.com/cotes2020/jekyll-theme-chirpy" target="_blank" rel="noopener">Chirpy</a> theme.</p></div></div></footer></div><div id="search-result-wrapper" class="d-flex justify-content-center unloaded"><div class="col-12 col-sm-11 post-content"><div id="search-hints"><h4 class="text-muted mb-4">Trending Tags</h4><a class="post-tag" href="/tags/portfolio/">portfolio</a> <a class="post-tag" href="/tags/isu/">ISU</a> <a class="post-tag" href="/tags/project/">project</a> <a class="post-tag" href="/tags/guide/">guide</a> <a class="post-tag" href="/tags/bytecode/">bytecode</a> <a class="post-tag" href="/tags/moonbeam/">moonbeam</a> <a class="post-tag" href="/tags/node/">node</a> <a class="post-tag" href="/tags/para-chain/">para chain</a> <a class="post-tag" href="/tags/reflection/">reflection</a> <a class="post-tag" href="/tags/server/">server</a></div><div id="search-results" class="d-flex flex-wrap justify-content-center text-muted mt-3"></div></div></div></div><div id="mask"></div><a id="back-to-top" href="#" aria-label="back-to-top" class="btn btn-lg btn-box-shadow" role="button"> <i class="fas fa-angle-up"></i> </a> <script src="https://cdn.jsdelivr.net/npm/simple-jekyll-search@1.7.3/dest/simple-jekyll-search.min.js"></script> <script> SimpleJekyllSearch({ searchInput: document.getElementById('search-input'), resultsContainer: document.getElementById('search-results'), json: '/assets/js/data/search.json', searchResultTemplate: '<div class="pl-1 pr-1 pl-sm-2 pr-sm-2 pl-lg-4 pr-lg-4 pl-xl-0 pr-xl-0"> <a href="https://jake-vaughn.com{url}">{title}</a><div class="post-meta d-flex flex-column flex-sm-row text-muted mt-1 mb-1"> {categories} {tags}</div><p>{snippet}</p></div>', noResultsText: '<p class="mt-5">Oops! No result founds.</p>', templateMiddleware: function(prop, value, template) { if (prop === 'categories') { if (value === '') { return `${value}`; } else { return `<div class="mr-sm-4"><i class="far fa-folder fa-fw"></i>${value}</div>`; } } if (prop === 'tags') { if (value === '') { return `${value}`; } else { return `<div><i class="fa fa-tag fa-fw"></i>${value}</div>`; } } } }); </script> <script src="https://cdn.jsdelivr.net/combine/npm/lozad/dist/lozad.min.js,npm/magnific-popup@1/dist/jquery.magnific-popup.min.js"></script> <script defer src="/assets/js/dist/post.min.js"></script> <script src="https://cdn.jsdelivr.net/combine/npm/popper.js@1.16.1,npm/bootstrap@4/dist/js/bootstrap.min.js"></script> <script defer src="/app.js"></script> <script defer src="https://www.googletagmanager.com/gtag/js?id="></script> <script> document.addEventListener("DOMContentLoaded", function(event) { window.dataLayer = window.dataLayer || []; function gtag(){dataLayer.push(arguments);} gtag('js', new Date()); gtag('config', ''); }); </script>
